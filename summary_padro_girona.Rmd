---
title: "Anàlisi del padró de Girona 2020"
author: "Pol Monsó Purtí"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=TRUE, error=TRUE)
```

Install dependencies
```{r, message=FALSE}
require('tidyverse')
require('dplyr')
require('ggplot2')
require('treemapify')
require('rgdal')
require('sf')
require('RColorBrewer')
require('classInt')

library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(treemapify)
library(rgdal)
library(sf)
library(RColorBrewer)
library(classInt)
```

Create a script to download information related to the register of
inhabitants during 2020, and save the table in a file called
padro_2020.RData.

```{r}
#filename = "data/padro_2020.RData"
filename = "data/padro_2020.csv"
if(!file.exists(filename)){
  csv_url = "https://terra.girona.cat/opendata/storage/f/2021-04-19T07%3A52%3A25.797Z/padro-2021.csv"
  data = read_csv2(csv_url, col_types = cols(districte = "c", seccio = "c"))
  #save(data, file=filename)
  write.csv2(data, filename)
} else {
  #data = load(filename)
  data = read_csv2(filename, col_types = cols(districte = "c", seccio = "c"))
}
```
Get the districts shapefile

```{r}
shapefile = 'data/Barris.shp'
if(!file.exists(shapefile)){
  destfile = "data/girona_shp.zip"
  girona_shp_zip = 'https://terra.girona.cat/opendata/storage/f/2014-07-31T06%3A08%3A39.903Z/barris.zip'
  download.file(girona_shp_zip , destfile=destfile)
  unzip(destfile, exdir='data/girona_shp')
}
```

Summarise the variable study levels (nivell_estudis). What are the most
common levels?

```{r}
arrange(summarize(group_by(data, nivell_estudis), popularitat = 100*n()/count(data)), desc(popularitat))
```

Summarise the average age within district (districte).

```{r}
summarize(group_by(data, districte), edat_mitja = mean(as.integer(format(Sys.Date(), "%Y")) - data_naixement))
```

Summarise the proportion of population with superior level studies in
each district.

## Obtenim la llista d'estudis

```{r}
summarize(group_by(data, nivell_estudis))
```
Els estudis superiors són:

* *1 ALTRES TÍTOLS DE GRAU MIG*
* *2 ARQUITECTE,ENGINYER TÈCNI* 
* 3 BATXILLER SUPERIOR, BUP
* 4 BATXILLER,FPII O SUPERIOR 
* *5 DIPLOMAT ESCOLA UNIVERS*
* *6 DOCTORAT I POST-GRAU*
* 7 ESO, PRIMÀRIA O EQUIV.
* *8 FP 1ER GRAU O MITJÀ*
* *9 FP 2ON GRAU O SUPERIOR*
* *10 LLICENCIAT O GRAU UNIVER.*
11 NI LLEGIR NI ESCRIURE
12 NO APLICABLE MENOR 16
13 PRIMÀRIA INCOMPLETA
14 SENSE ESTUDIS
* *15 TÍTOL SUP NO UNIVERSITARI*

```{r}
estudis_superiors = c(
  'ALTRES TÍTOLS DE GRAU MIG',
  'ARQUITECTE,ENGINYERTÈCNI',
  'DIPLOMAT ESCOLA UNIVERS.',
  'DOCTORAT I POST-GRAU',
  'FP 1ER GRAU O MITJÀ',
  'FP 2ON GRAU O SUPERIOR',
  'LLICENCIAT O GRAU UNIVER.',
  'TÍTOL SUP NO UNIVERSITARI'
)

summarize(group_by(data, districte), superiors = 100*mean(nivell_estudis %in% estudis_superiors, rm.NA = TRUE))
```

si volem treure els menors de 16

```{r}
data_adults = filter(data, nivell_estudis != 'NO APLICABLE MENOR 16')
dist_estudis = summarize(group_by(data_adults, districte), superiors = round(100*mean(nivell_estudis %in% estudis_superiors, rm.NA = TRUE), digits = 2))
dist_estudis
```

Visualització en forma de barres

```{r}
ggplot(dist_estudis, aes(x=districte, y=superiors, labels=districte)) +
  geom_segment( aes(x=districte, xend=districte, y=0, yend=superiors)) +
  geom_point( size=3, color="red", fill=alpha("brown", 0.3), alpha=0.7, shape=21, stroke=2) +
  theme_minimal()
```

Visualització en forma de mapa

```{r}
nclr = 9
plotclr = brewer.pal(nclr,"BuPu")
class = classIntervals(pull(dist_estudis), nclr, style="equal")
colcode = findColours(class, plotclr)

orgirona_sf = st_read(shapefile)
title = "Nivell d'estudis per districte"
subtitle = "Percentatge sobre el total de població del districte"
plot(orgirona_sf['BARRIS'], col=colcode, main=NULL)
title(main=title, sub=subtitle)
legend("bottomright", legend=names(attr(colcode, "table")),
       fill=attr(colcode, "palette"), cex=1.0, bty="n")
```

